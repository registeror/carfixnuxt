import{e as Z,u as G,r as d,k as H,y as N,c as r,a as t,h as g,i as T,v as Y,F as O,p as P,g as B,t as i,d as $,q as ee,o as u,A as te,b as se,w as oe,D as ae}from"./D1iNbD-i.js";import"./BbCOxZKf.js";import{u as k}from"./DQ2dyhc-.js";import{_ as le}from"./C3d_DK6E.js";import"./_d1bhYXs.js";const ne={class:"div-body-yAdmin"},ie={class:"container-order"},re={class:"search-box"},ue={class:"order-list"},de=["onClick"],ce={class:"order-info"},ve={class:"field-value order-number"},me={class:"field-value order-gmail"},pe={class:"field-value phone"},fe={class:"modal-actions"},he={class:"notification-container"},ye={class:"SliderModal"},_e={class:"SlidesModal"},ge={class:"PageModal ActiveModal"},ke={class:"ContainerModal"},we={class:"ProductImageModal"},Ce=["src"],be={class:"InfoProductModal"},xe={class:"ProductNameModal"},Me={key:0,class:"ProductSizeModalBox"},Ne={class:"hsixstyle"},Oe={class:"ProductOneOrderModalBox"},$e={class:"hsixstyle"},Se={class:"QuantityProductModal"},Pe=["onClick"],De=["id","value","onInput","onBlur"],Te=["onClick"],Be={class:"ProductSumPrice"},Ee={id:"hfivestyle"},qe={class:"DeliteProductModal"},Ae=["onClick"],Fe={key:0,class:"modal-info"},Xe={class:"order-info-text"},Ie={class:"order-info-text"},Ke={class:"order-info-text"},Qe={class:"order-info-text"},Re={class:"order-info-text"},Le={key:0,style:{"text-decoration":"line-through",color:"#999"}},Ve={class:"modal-actions"},Ge=Z({__name:"index",setup(Ue){const{public:{apiBaseUrl:_}}=G(),w=d([]),h=d([]),S=d(!1),v=d(null),C=d(""),m=d("Не готов"),y=d(!1),p=d(null);d(!1),d("");const l=d(null);let E=0;const D=s=>{const e=E++;w.value.unshift({message:s,id:e}),setTimeout(()=>{w.value=w.value.filter(a=>a.id!==e)},3e3)},b=s=>new Intl.NumberFormat("ru-RU",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2}).format(s).replace(/\s/g,".");H(async()=>{try{const s=await $fetch(`${_}/api/admins/check-auth`,{credentials:"include",headers:{"X-XSRF-TOKEN":k("csrf").value}});!s.success||s.role!=="yAdmin"?window.location.href="/admin":await A()}catch{window.location.href="/admin"}});const q=async()=>{try{await $fetch(`${_}/api/admins/logout`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-XSRF-TOKEN":k("csrf").value}}),window.location.href="/admin"}catch{}},A=async()=>{try{const s=await $fetch(`${_}/api/orders`,{credentials:"include",headers:{"X-XSRF-TOKEN":k("csrf").value}});h.value=s}catch{}},F=s=>{p.value=s,y.value=!0},X=N(()=>{let s=h.value;if(C.value){const a=C.value.toLowerCase();if(a.startsWith("#")){const n=a.slice(1);s=s.filter(o=>o.orderNumber.toString().includes(n))}else s=s.filter(n=>n.orderNumber.toString().includes(a)||n["order-gmail"].toLowerCase().includes(a)||n["order-phone"].toLowerCase().includes(a))}const e={"Не готов":3,"В обработке":2,"В процессе":1,Готов:0};return s.sort((a,n)=>{const o=a["order-status"],c=n["order-status"];return o in e&&c in e&&e[c]-e[o]||n.orderNumber-a.orderNumber})}),I=s=>{v.value=s,l.value=JSON.parse(JSON.stringify(s)),m.value=s["order-status"],s["order-status"]!=="Готов"&&(v.value["order-status"]="В обработке"),S.value=!0},x=()=>{S.value=!1,v.value=null,l.value=null,m.value="Не готов"},K=async()=>{if(p.value)try{await $fetch(`${_}/api/orders/${p.value._id}`,{method:"DELETE",credentials:"include",headers:{"X-XSRF-TOKEN":k("csrf").value}}),h.value=h.value.filter(s=>{var e;return s._id!==((e=p.value)==null?void 0:e._id)}),D(`Был удален заказ #${p.value.orderNumber}`),y.value=!1,p.value=null,x()}catch{}},Q=(s,e)=>{l.value&&(l.value.items=l.value.items.filter(a=>!(a["items-product-id"]===s&&a["items-product-volume"]===e)))},R=async()=>{if(l.value&&v.value)try{if(!["Не готов","В обработке","В процессе","Готов"].includes(m.value))throw new Error("Недопустимый статус заказа");v.value.items=[...l.value.items],v.value["order-status"]=m.value,await $fetch(`${_}/api/orders/${v.value._id}`,{method:"PUT",body:{"order-status":m.value,items:l.value.items},credentials:"include",headers:{"Content-Type":"application/json","X-XSRF-TOKEN":k("csrf").value}}),h.value=h.value.map(e=>{var a;return e._id===((a=v.value)==null?void 0:a._id)?{...e,"order-status":m.value,items:[...l.value.items]}:e}),x()}catch{D("Ошибка при сохранении изменений")}},M=(s,e,a)=>{if(!l.value)return 1;const n=Math.max(1,Math.min(99,+e||1)),o=l.value.items.find(c=>c["items-product-id"]===s&&c["items-product-volume"]===a);return o&&(o["items-quantity"]=n),n},L=(s,e)=>{const a=s.target,n=M(e["items-product-id"],a.value,e["items-product-volume"]);a.value=n.toString()},V=s=>{/[0-9]|Backspace|Delete|ArrowLeft|ArrowRight/.test(s.key)||s.preventDefault()},U=(s,e)=>{const a=s.target;a.value||(a.value="1",M(e["items-product-id"],1,e["items-product-volume"]))},j=N(()=>l.value?l.value.items.reduce((s,e)=>s+(e["items-final-price"]||e["items-price"]*e["items-quantity"]),0):0),z=s=>{/[a-zA-Z0-9@.#+\s]|Backspace|Delete|ArrowLeft|ArrowRight|Tab|Escape|Enter/.test(s.key)||s.preventDefault()},J=N(()=>{var s;return(s=l.value)==null?void 0:s.items.some(e=>e["items-promocode"])}),W=N(()=>l.value?l.value.items.reduce((s,e)=>s+(e["items-original-price"]||e["items-price"]*e["items-quantity"]),0):0);return(s,e)=>{var a,n;return u(),r(O,null,[t("button",{onClick:q,class:"logout-class"},"Выйти"),t("div",ne,[t("div",ie,[t("div",re,[T(t("input",{"onUpdate:modelValue":e[0]||(e[0]=o=>C.value=o),type:"text",placeholder:"Поиск по номеру заказа, почте или телефону",class:"search-input",onKeydown:z},null,544),[[Y,C.value]])]),t("div",ue,[(u(!0),r(O,null,P(X.value,(o,c)=>(u(),r("div",{key:c,class:"order-item",onClick:f=>I(o)},[t("div",ce,[t("span",ve,"#"+i(o.orderNumber),1),t("span",me,i(o["order-gmail"]),1),t("span",pe,i(o["order-phone"]),1),t("span",{class:te(["status",{ready:o["order-status"]==="Готов","not-ready":o["order-status"]==="Не готов",processing:o["order-status"]==="В обработке","in-progress":o["order-status"]==="В процессе"}])},i(o["order-status"]),3)])],8,de))),128))]),y.value?(u(),r("div",{key:0,class:"modal-overlay-delete",onClick:e[4]||(e[4]=o=>y.value=!1)},[t("div",{class:"modal-content-delete",onClick:e[3]||(e[3]=B(()=>{},["stop"]))},[t("span",{class:"close-yAdmin",onClick:e[1]||(e[1]=o=>y.value=!1)},"×"),t("h2",null,"Вы действительно хотите удалить заказ #"+i((a=p.value)==null?void 0:a.orderNumber)+"?",1),t("div",fe,[t("button",{onClick:K,class:"btn-delete"},"Удалить"),t("button",{onClick:e[2]||(e[2]=o=>y.value=!1),class:"btn-cancel"},"Отмена")])])])):g("",!0),t("div",he,[(u(!0),r(O,null,P(w.value,o=>(u(),r("div",{key:o.id,class:"notification"},i(o.message),1))),128))]),S.value?(u(),r("div",{key:1,class:"modal-overlay",onClick:x},[t("div",{class:"modal-content",onClick:e[7]||(e[7]=B(()=>{},["stop"]))},[t("span",{class:"close-yAdmin",onClick:x},"×"),e[14]||(e[14]=t("h2",{style:{"text-align":"left"}},"Информация о заказе:",-1)),t("div",ye,[t("div",_e,[t("div",ge,[t("div",ke,[(u(!0),r(O,null,P((n=l.value)==null?void 0:n.items,(o,c)=>(u(),r("div",{key:c,class:"itemModal"},[t("div",we,[se(ae(le),{to:`/product/${o["items-product-id"]}`},{default:oe(()=>[t("img",{src:o["items-product-image"],style:{width:"100%",height:"100%","object-fit":"cover"}},null,8,Ce)]),_:2},1032,["to"])]),t("div",be,[t("h4",xe,i(o["items-product-name"]),1),o["items-has-volume"]?(u(),r("div",Me,[t("h5",Ne,"Размер: "+i(o["items-product-volume"]),1)])):g("",!0),t("div",Oe,[t("h5",$e,i(b(o["items-price"]))+" р./шт",1)]),t("div",Se,[t("button",{onClick:f=>M(o["items-product-id"],o["items-quantity"]-1,o["items-product-volume"]),class:"BtnsQuantity"},"-",8,Pe),t("input",{type:"number",id:`quantity${c}`,class:"quantitystye",value:o["items-quantity"],onInput:f=>L(f,o),onKeydown:V,onBlur:f=>U(f,o),min:"1",max:"99"},null,40,De),t("button",{onClick:f=>M(o["items-product-id"],o["items-quantity"]+1,o["items-product-volume"]),class:"BtnsQuantity Plus"},"+",8,Te)])]),t("div",Be,[t("h4",Ee,i(b(o["items-price"]*o["items-quantity"]))+" /Руб.",1)]),t("div",qe,[t("button",{onClick:f=>Q(o["items-product-id"],o["items-product-volume"]),class:"BtnsDeliteProductModal"},"X",8,Ae)])]))),128))])])])]),l.value?(u(),r("div",Fe,[t("p",Xe,[e[8]||(e[8]=t("strong",null,"Имя:",-1)),$(" "+i(l.value["order-name"]),1)]),t("p",Ie,[e[9]||(e[9]=t("strong",null,"Почта:",-1)),$(" "+i(l.value["order-gmail"]),1)]),t("p",Ke,[e[10]||(e[10]=t("strong",null,"Телефон:",-1)),$(" "+i(l.value["order-phone"]),1)]),t("p",Qe,[e[12]||(e[12]=t("strong",{style:{"margin-top":"2px"}},"Статус:",-1)),T(t("select",{"onUpdate:modelValue":e[5]||(e[5]=o=>m.value=o),style:{height:"28px",padding:"0px"}},e[11]||(e[11]=[t("option",{value:"Не готов"},"Не готов",-1),t("option",{value:"В обработке"},"В обработке",-1),t("option",{value:"В процессе"},"В процессе",-1),t("option",{value:"Готов"},"Готов",-1)]),512),[[ee,m.value]])]),t("p",Re,[e[13]||(e[13]=t("strong",null,"Сумма:",-1)),$(" "+i(b(j.value))+"р ",1),J.value?(u(),r("span",Le,i(b(W.value))+"р ",1)):g("",!0)])])):g("",!0),t("div",Ve,[t("button",{onClick:R,class:"btn-save"},"Сохранить изменения"),t("button",{onClick:e[6]||(e[6]=o=>F(v.value)),class:"btn-delete"},"Удалить заказ")])])])):g("",!0)])])],64)}}});export{Ge as default};

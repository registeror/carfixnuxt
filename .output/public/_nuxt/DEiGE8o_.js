import{_ as ee}from"./C3d_DK6E.js";import{e as te,u as ae,r as p,f as X,k as U,c as g,a as o,b as le,w as ne,h as N,t as K,i as P,v as R,d as oe,l as se,m as ue,F as $,p as j,q as re,n as ie,o as h,x as ce}from"./D1iNbD-i.js";import"./BbCOxZKf.js";import{u as D}from"./DQ2dyhc-.js";import"./_d1bhYXs.js";const de={class:"GoBackBody"},ve={class:"PageProductBody"},pe={class:"PageProductContent"},me={class:"PageImageProduct"},fe={for:"imageUpload",class:"PageBtnProductAdd",style:{cursor:"pointer"}},ge=["src"],he={class:"PageProductRightBlock"},ke={class:"PageProductText"},Pe={class:"product-name-block"},ye={class:"volume-toggle"},_e={key:0,class:"volume-items-container"},we=["onUpdate:modelValue","onInput","placeholder"],Ie=["onUpdate:modelValue","placeholder"],Ve=["onClick"],be={class:"PageVolumeSelection"},Ce=["value"],xe={class:"PageProductDescriptionBlock"},Te=te({__name:"index",setup(Ne){const{public:{apiBaseUrl:S}}=ae(),y=p(null),w=p(""),d=p(null),_=p(""),F=p([]),b=p(""),r=p(null),c=p(!1),m=p([{volume:"",price:""}]),I=p(null),B=a=>!/<[^>]*>|[\<\>\"\'\`\;\(\)\&\$\%\#\@\*\+\=\\\/\|\{\}\[\]]/.test(a),E=a=>a.replace(/<[^>]*>|[\<\>\"\'\`\;\(\)\&\$\%\#\@\*\+\=\\\/\|\{\}\[\]]/g,""),G=a=>{const e=a.target;B(e.value)||(e.value=E(e.value)),w.value=e.value},H=a=>{const e=a.target;B(e.value)||(e.value=E(e.value)),_.value=e.value,L()},q=(a,e)=>{const l=e.target;B(l.value)||(l.value=E(l.value)),m.value[a].volume=l.value},O=(a,e=!1)=>{if(!a)return",00";let l=a.replace(/[^\d,]/g,"");const t=l.includes(",");let[s="",n=""]=l.split(",");return n=n.slice(0,2),s=s.replace(/\B(?=(\d{3})+(?!\d))/g,"."),!t&&e?s:(!t&&n&&(s=s.slice(0,-n.length)||"0"),s+(t||n?","+n.padEnd(2,"0"):""))},A=()=>{if(r.value){let a=r.value.value;const e=n=>{const u=n,i=n.target,v=i.selectionStart,T=i.value,k=u.inputType==="deleteContentBackward";if(i.value===""){d.value=null,a="";return}const V=a.includes(",")&&!i.value.includes(","),f=O(i.value,k&&V);i.value=f;const M=parseFloat(f.replace(/\./g,"").replace(",","."));if(d.value=isNaN(M)?null:M,v!==null){let x=v;if(V&&k){const Z=a.indexOf(",");v>Z&&(x=v-1)}else f.includes(",")&&!T.includes(",")&&(x=f.indexOf(",")+1);i.setSelectionRange(x,x)}a=f},l=n=>{const u=n.target;!u.value.trim()||u.value===",00"?(u.value="",d.value=null,a=""):(u.value=O(u.value),a=u.value)},t=n=>{const u=n.target;u.value===",00"&&setTimeout(()=>{u.setSelectionRange(0,0)},10)},s=n=>{if(n.key==="Backspace"){const u=n.target,i=u.selectionStart,v=u.value;i&&v[i-1]===","&&(n.preventDefault(),u.setSelectionRange(i-1,i-1))}};r.value.removeEventListener("input",e),r.value.removeEventListener("blur",l),r.value.removeEventListener("focus",t),r.value.removeEventListener("keydown",s),r.value.addEventListener("input",e),r.value.addEventListener("blur",l),r.value.addEventListener("focus",t),r.value.addEventListener("keydown",s),r.value.value="",a=""}};X(c,a=>{a||(m.value=[{volume:"",price:""}],ce(()=>{r.value&&(r.value.value=",00",A())}))});const L=()=>{I.value&&(I.value.style.height="auto",I.value.style.height=`${I.value.scrollHeight}px`)};X(_,()=>{L()});const z=()=>{m.value.push({volume:"",price:""})},W=a=>{m.value.length>1&&m.value.splice(a,1)};U(()=>{if(r.value){const a=e=>{e=e.replace(/[^\d,]/g,"");const[l,t=""]=e.split(","),s=l.replace(/\B(?=(\d{3})+(?!\d))/g,"."),n=t.slice(0,2).padEnd(2,"0");return s+","+n};r.value.addEventListener("input",e=>{const l=e.target,t=l.selectionStart;let s=l.value;if(s.indexOf(",")===-1&&l.value.indexOf(",")!==-1&&t!==null){s=s.slice(0,t)+","+s.slice(t),l.value=s;const v=Math.max(t-1,0);l.setSelectionRange(v,v);return}const u=a(s);l.value=u;const i=u.replace(/\./g,"").replace(",",".");if(d.value=parseFloat(i)||null,t!==null){const v=u.slice(0,t).split("").filter(f=>f===".").length,T=s.slice(0,t).split("").filter(f=>f===".").length;let k=t+(v-T);const V=u.indexOf(",");V!==-1&&k>V&&(k=Math.min(k,u.length)),l.setSelectionRange(k,k)}u===",00"&&l.setSelectionRange(0,0)}),r.value.addEventListener("focus",()=>{setTimeout(()=>{var l,t;(((l=r.value)==null?void 0:l.value)||"")===",00"&&((t=r.value)==null||t.setSelectionRange(0,0))},10)}),r.value.value=",00"}}),U(async()=>{try{const a=await $fetch(`${S}/api/admins/check-auth`,{credentials:"include",headers:{"X-XSRF-TOKEN":D("csrf").value}});(!a.success||a.role!=="sAdmin")&&(window.location.href="/admin")}catch{window.location.href="/admin"}});const C=a=>{const l=a.target.value.replace(/\./g,"").replace(",","."),t=parseFloat(l);isNaN(t)?d.value=null:(d.value=t,localStorage.setItem("lastPrice",t.toString()))},J=a=>{var t;const l=(t=a.target.files)==null?void 0:t[0];if(l){const s=new FileReader;s.onload=n=>{n.target&&n.target.result&&(y.value=n.target.result)},s.readAsDataURL(l)}},Q=async()=>{try{const a=await $fetch(`${S}/api/categories`,{credentials:"include",headers:{"X-XSRF-TOKEN":D("csrf").value}});F.value=a.filter(e=>e["categories-name"]!=="Все")}catch{}},Y=async()=>{if(!w.value||!_.value||!b.value||!y.value){alert("Все поля обязательны для заполнения");return}if(c.value){for(const e of m.value)if(!e.volume||e.price===""||isNaN(Number(e.price))){alert("Все поля объема и цены обязательны для заполнения");return}}else{if(d.value===null||isNaN(d.value)){alert("Поле цены обязательно для заполнения");return}if(d.value===0){alert("Товар не может стоит 0р");return}}c.value||Number(d.value);const a={"product-name":w.value,"product-description":_.value,"product-has-volume":c.value,"product-image":y.value,"product-category":b.value,"product-price":c.value?null:Number(d.value),items:c.value?m.value.map(e=>({"product-volume":e.volume,"product-price":Number(e.price)})):void 0};try{const e=await $fetch(`${S}/api/products`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-XSRF-TOKEN":D("csrf").value},body:a});if(!e)throw new Error("Пустой ответ от сервера");if(e===!1)throw new Error(e||"Ошибка при сохранении товара");ie("/admin/sAdmin")}catch{alert("Ошибка при сохранении товара")}};return U(()=>{Q(),L(),A()}),(a,e)=>{const l=ee;return h(),g($,null,[e[7]||(e[7]=o("meta",{charset:"utf-8"},null,-1)),e[8]||(e[8]=o("meta",{name:"viewport",content:"width=device-width, initial-scale=1"},null,-1)),e[9]||(e[9]=o("title",null,"Создание товара",-1)),e[10]||(e[10]=o("link",{rel:"icon",href:"@/image/IcoL.ico",type:"image/x-icon"},null,-1)),o("div",de,[le(l,{to:"/admin/sAdmin"},{default:ne(()=>e[4]||(e[4]=[o("a",{class:"BtnGoBack"},"<- назад",-1)])),_:1})]),o("div",ve,[o("div",pe,[o("div",me,[o("input",{type:"file",accept:"image/*",onChange:J,style:{display:"none"},id:"imageUpload"},null,32),o("label",fe,K(y.value?"Изменить изображение":"Загрузить изображение"),1),y.value?(h(),g("img",{key:0,src:y.value,style:{width:"100%",height:"100%","object-fit":"cover"}},null,8,ge)):N("",!0)]),o("div",he,[o("div",ke,[o("div",Pe,[P(o("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>w.value=t),placeholder:"Введите название товара",onInput:G,class:"custom-input name-input"},null,544),[[R,w.value]])]),o("div",ye,[o("label",null,[P(o("input",{type:"checkbox","onUpdate:modelValue":e[1]||(e[1]=t=>c.value=t)},null,512),[[se,c.value]]),e[5]||(e[5]=oe(" Товар имеет несколько размеров "))])]),P(o("div",null,[o("input",{ref_key:"priceInputRef",ref:r,placeholder:"Введите цену товара",class:"custom-input price-input-basic",onInput:C,onChange:C},null,544)],512),[[ue,!c.value]]),c.value?(h(),g("div",_e,[(h(!0),g($,null,j(m.value,(t,s)=>(h(),g("div",{key:s,class:"volume-item"},[P(o("input",{"onUpdate:modelValue":n=>t.volume=n,onInput:n=>q(s,n),placeholder:`Рзмер ${s+1}`,class:"custom-input volume-input"},null,40,we),[[R,t.volume]]),P(o("input",{"onUpdate:modelValue":n=>t.price=n,placeholder:`Стоимость ${s+1}`,class:"custom-input price-input",onInput:C,onChange:C,ref_for:!0,ref_key:"priceInputRef",ref:r},null,40,Ie),[[R,t.price,void 0,{number:!0}]]),c.value&&m.value.length>1?(h(),g("button",{key:0,onClick:n=>W(s),class:"remove-volume-btn"},"× ",8,Ve)):N("",!0)]))),128)),c.value?(h(),g("button",{key:0,onClick:z,class:"add-volume-btn"},"+ Добавить вариант ")):N("",!0)])):N("",!0),o("div",be,[P(o("select",{"onUpdate:modelValue":e[2]||(e[2]=t=>b.value=t),class:"custom-select category-select"},[e[6]||(e[6]=o("option",{value:"",disabled:"",selected:""},"Выберите категорию товара",-1)),(h(!0),g($,null,j(F.value,t=>(h(),g("option",{key:t._id,value:t._id},K(t["categories-name"]),9,Ce))),128))],512),[[re,b.value]])]),o("div",{class:"PageButtonProductAdd"},[o("button",{class:"PageAdminBtnProductAdd",onClick:Y},"Сохранить")])]),o("div",xe,[P(o("textarea",{ref_key:"textareaRef",ref:I,"onUpdate:modelValue":e[3]||(e[3]=t=>_.value=t),placeholder:"Введите описание товара",class:"custom-textarea product-description",onInput:H},null,544),[[R,_.value]])])])])])],64)}}});export{Te as default};
